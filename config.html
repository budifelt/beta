<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EDM Config Editor @budifelt</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    height: 100vh;
    display: flex;
    overflow: hidden;
    background-color: #fce8e6;
    color: #222222;
  }
#sidebar {
  width: 250px;
  min-width: 250px;
  max-width: 250px;
  background-color: #f9d5d3;
  color: #222222;
  display: flex;
  flex-direction: column;
  padding: 10px;
  box-sizing: border-box;
  overflow: hidden;
  box-shadow: 2px 0 5px rgba(0,0,0,0.05);
}
  #sidebar h2 {
    color: #222222;
    font-size: 1.2em;
    margin: 0 0 10px 0;
    padding-bottom: 10px;
    border-bottom: 1px solid #e6b8b5;
  }
  #folderOpenBtn {
    background-color: #222222;
    border: none;
    color: white;
    padding: 8px 12px;
    font-size: 1em;
    cursor: pointer;
    margin-bottom: 10px;
    border-radius: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    transition: background-color 0.3s ease;
  }
  #folderOpenBtn:hover {
    background-color: #444444;
  }
  #fileList {
    flex-grow: 1;
    overflow-y: auto;
    border-top: 1px solid #e6b8b5;
    padding-top: 10px;
  }
  #fileList ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
  }
  #fileList li {
    padding: 5px 8px 5px 28px;
    cursor: pointer;
    border-radius: 10px;
    position: relative;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  #fileList li:hover, #fileList li:focus {
    outline: none;
    background-color: #e6b8b5;
  }
  #fileList li.selected {
    background-color: #d9a8a5;
  }
  #fileList li.folder {
    padding-left: 20px;
    position: relative;
    display: block;
  }
  #fileList li.folder .arrow {
    display: inline-block;
    width: 12px;
    height: 12px;
    margin-right: 4px;
    cursor: pointer;
    user-select: none;
    transition: transform 0.2s ease;
    vertical-align: middle;
  }
  #fileList li.folder .arrow::before {
    content: "▶";
    display: inline-block;
    font-size: 12px;
    line-height: 12px;
    transform-origin: center;
  }
  #fileList li.folder.open > .arrow::before {
    transform: rotate(90deg);
  }
  #fileList li.folder .folder-icon {
    display: inline-block;
    width: 16px;
    height: 16px;
    margin-right: 6px;
    user-select: none;
    vertical-align: middle;
  }
  #fileList li.folder .folder-icon::before {
    content: "📁";
    font-size: 16px;
    line-height: 16px;
  }
  #fileList li.folder .folder-name {
    display: inline-block;
    user-select: none;
    vertical-align: middle;
    white-space: nowrap;
  }
  #fileList li.file {
    padding-left: 8px;
    position: relative;
    white-space: nowrap;
    display: flex;
    align-items: center;
  }
  #fileList li.file::before {
    content: none;
  }
  #fileList li.file .file-icon {
    margin-right: 6px;
    font-size: 16px;
    line-height: 16px;
    user-select: none;
  }
  #fileList li.file .file-name {
    white-space: nowrap;
  }
  #fileList ul {
    list-style: none;
    padding-left: 20px;
    margin: 0;
    position: relative;
  }
  #fileList ul::before {
    content: "";
    position: absolute;
    top: 0;
    left: 10px;
    width: 1px;
    height: 100%;
    background: #e6b8b5;
  }
  #fileList li {
    position: relative;
    padding-left: 20px;
  }
  #fileList li::before {
    content: "";
    position: absolute;
    top: 12px;
    left: 0;
    width: 10px;
    height: 1px;
    background: #e6b8b5;
  }
  #fileList li:last-child::before {
    background: transparent;
  }
  #fileList li.folder > ul {
    margin-left: 0;
  }
  #fileList li:hover, #fileList li:focus {
    box-shadow: none;
  }
  #mainContent {
    flex-grow: 1;
    padding: 20px;
    overflow-y: auto;
    background-color: #fff0f0;
    color: #222222;
  }
  label {
    display: block;
    margin-top: 15px;
    font-weight: 600;
    color: #222222;
  }
  input[type="text"], select {
    width: 550px;
    padding: 8px 12px;
    font-size: 1em;
    border: 1px solid #e6b8b5;
    border-radius: 20px;
    background-color: #fff;
    color: #222222;
    transition: border-color 0.3s ease;
  }
  input[type="text"]:focus, select:focus {
    border-color: #d9a8a5;
    outline: none;
  }
  textarea {
    width: 100%;
    height: 350px;
    margin-top: 20px;
    font-family: monospace;
    font-size: 0.9em;
    border: 1px solid #e6b8b5;
    border-radius: 20px;
    background-color: #fff;
    color: #222222;
    padding: 10px;
    resize: vertical;
  }
  button {
    margin-top: 15px;
    padding: 10px 20px;
    font-size: 1em;
    background-color: #222222;
    color: white;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #444444;
  }
  #campaignCountIndicator {
    font-weight: 600;
    margin-left: 10px;
    color: #222222;
  }

  #campaignIdValidation {
    margin-top: 4px;
    font-size: 14px;
    color: #666666;
    display: flex;
    justify-content: flex-start;
    gap: 8px;
  }
  #campaignIdValidation label {
    font-weight: normal;
  }


  /* Tooltip container */
  .tooltip {
    position: relative;
    display: inline-block;
  }

  /* Tooltip text */
  .tooltip .tooltiptext {
    visibility: hidden;
    width: max-content;
    max-width: 200px;
    background-color: #222222;
    color: #fff;
    text-align: center;
    border-radius: 10px;
    padding: 10px 14px;
    position: absolute;
    z-index: 10;
    bottom: 125%; /* Position above the button */
    left: 50%;
    transform: translateX(-50%);
    opacity: 0;
    transition: opacity 0.3s;
    font-size: 15px;
    font-weight: normal;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }

  /* Tooltip arrow */
  .tooltip .tooltiptext::after {
    content: "";
    position: absolute;
    top: 100%; /* At the bottom of the tooltip */
    left: 50%;
    transform: translateX(-50%);
    border-width: 6px;
    border-style: solid;
    border-color: #222222 transparent transparent transparent;
  }

  /* Show the tooltip text when hovering */
  .tooltip:hover .tooltiptext {
    visibility: visible;
    opacity: 1;
  }
</style>

<style id="theme-overrides">
:root{
  --bg1:#3940b8; --bg2:#5a3f8f;
  --surface:#0b1220; --surface-elev:#111827;
  --text:#e5e7eb; --text-strong:#f3f4f6; --muted:#9aa4b2;
  --ring:#7c89ff; --glow1:#667eea; --glow2:#764ba2;
  --radius:16px; --space:clamp(14px,2vw,24px); --container:1100px;
  --shadow:0 10px 28px rgba(0,0,0,.30);
  --shadow-lg:0 22px 60px rgba(20,30,60,.45);
}
/* Base */
html,body{height:100%}
body{
  color:var(--text) !important;
  background: linear-gradient(135deg, var(--bg1), var(--bg2)) !important;
  font-family: ui-sans-serif, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, Arial, sans-serif !important;
}
/* Common containers */
.container, #mainContent, .calendar, .counter-container, .instructions, .history-container,
#sidebar, #fileList, #databaseContent, #resultsContainer, #krhredResults, #krhredDetails,
#contentContainer, #editor, textarea, input[type="text"], input[type="search"], select, .virtual-scroll-container {
  background: var(--surface) !important;
  color: var(--text) !important;
  border-color: rgba(255,255,255,.08) !important;
  box-shadow: var(--shadow);
}
/* Cards/panels subtle elevation */
.container, .calendar, .counter-container, #mainContent, .instructions, .history-container{
  border-radius: var(--radius);
  position: relative;
  overflow: hidden;
}
.container::after, .calendar::after, .counter-container::after, #mainContent::after {
  content:""; position:absolute; inset:-2px; border-radius:inherit;
  background:linear-gradient(45deg,var(--glow1),var(--glow2));
  opacity:.18; pointer-events:none; mix-blend-mode:screen;
}
/* Headings & text */
h1,h2,h3,h4,h5 { color: var(--text-strong) !important; }
p, label, .sync-status, .last-updated, .text-slate-400 { color: var(--muted) !important; }
/* Buttons */
button, .bookmarklet {
  background: var(--surface-elev) !important;
  color: var(--text) !important;
  border:1.5px solid rgba(255,255,255,.08) !important;
  border-radius: var(--radius) !important;
  box-shadow: var(--shadow);
  transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
}
button:hover, .bookmarklet:hover {
  transform: translateY(-2px);
  background:#0f172a !important;
  border-color: rgba(124,137,255,.55) !important;
  box-shadow: var(--shadow-lg);
}
/* Links */
a { color: #9bb1ff !important; }
/* Inputs & textareas */
input, textarea, select {
  border-radius: var(--radius) !important;
  background: #0f172a !important;
  color: var(--text) !important;
  border:1px solid rgba(255,255,255,.10) !important;
}
input::placeholder, textarea::placeholder { color: #9aa4b2 !important; }
/* Tables */
table { color: var(--text) !important; }
th, td { border-color: rgba(255,255,255,.10) !important; }
thead { background: #0f172a !important; }
/* Specific elements in provided files */
/* Database Checker */
#databaseContent { background:#0f172a !important; }
#krhredResults, #krhredDetails { background:#111827 !important; }
/* WFH Tracker calendar day colors */
.day.today { background:#64ffda !important; color:#0a192f !important; }
.day.wfh { background:#4caf50 !important; color:#fff !important; }
.day.other { background:#ff9800 !important; color:#fff !important; }
.day.weekend { background:#ef4444 !important; color:#fff !important; }
/* Bookmarklet page container */
body > .container { background: var(--surface) !important; }
/* Counter */
.buttons button:disabled { opacity:.5 !important; }
/* Scroll containers borders subtle */
#sidebar, #fileList { box-shadow: none !important; }
/* Keep selection visible */
::selection { background: rgba(124,137,255,.35); color:#fff; }
</style>
</head>
<body>
<div id="sidebar">
  <button id="folderOpenBtn">Open Folder</button>
  <div id="fileList"><ul></ul></div>
</div>
<div id="mainContent">
<h1>EDM Config Editor</h1>

<label for="campaignId">Campaign ID: <span id="campaignIdCharCount">(0)</span></label>
<div style="display: inline-block; position: relative;">
  <input type="text" id="campaignId" style="padding-right: 24px;" />
  <span id="campaignIdCheckmark" style="display:none; position: absolute; right: 6px; top: 50%; transform: translateY(-50%); color: green; font-size: 18px;">✔️</span>
</div>
<button id="updateCampaignIdBtn">Update Campaign ID</button>
<span id="campaignCountIndicator"></span>
  <div id="campaignIdValidation" style="display: flex; align-items: center; gap: 10px;">
    <span id="mismatchWarning" style="color: red; display: none;">
      Campaign ID and link mismatch!
    </span>
  </div>






<label for="subject">Subject: <span id="subjectCharCount">(0)</span></label>
<div style="display: inline-block; position: relative;">
  <input type="text" id="subject" style="padding-right: 24px;" />
  <span id="subjectCheckmark" style="display:none; position: absolute; right: 6px; top: 50%; transform: translateY(-50%); color: green; font-size: 18px;">✔️</span>
</div>
<button id="updateSubjectBtn">Update Subject</button>

<label for="link">Link (content):</label>
<div style="display: inline-block; position: relative;">
  <input type="text" id="link" style="padding-right: 24px;" />
  <span id="linkCheckmark" style="display:none; position: absolute; right: 6px; top: 50%; transform: translateY(-50%); color: green; font-size: 18px;">✔️</span>
</div>
<button id="updateLinkBtn">Update Link</button>

<button id="saveFileBtn">Save Changes</button>

  <div style="display: flex; align-items: center; gap: 10px;">
    <h2>XML Content</h2>
  </div>
<div id="editor" style="white-space: pre-wrap; font-family: monospace; height: 350px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background-color: white;"></div>
</div>

<script>
  let fileHandle;
  let xmlDoc;

  // Removed openFileBtn references as Open XML File button is removed
  const saveFileBtn = document.getElementById('saveFileBtn');
  const editor = document.getElementById('editor');
  const campaignIdInput = document.getElementById('campaignId');
  const updateCampaignIdBtn = document.getElementById('updateCampaignIdBtn');
  const subjectInput = document.getElementById('subject');
  const updateSubjectBtn = document.getElementById('updateSubjectBtn');
  const linkInput = document.getElementById('link');
  const updateLinkBtn = document.getElementById('updateLinkBtn');
  const campaignCountIndicator = document.getElementById('campaignCountIndicator');

  const folderOpenBtn = document.getElementById('folderOpenBtn');
  const fileList = document.getElementById('fileList').querySelector('ul');

  saveFileBtn.addEventListener('click', async () => {
    if (!fileHandle) {
      alert("No file opened yet.");
      return;
    }
    if (!editor.textContent.trim()) {
      alert("Editor is empty, cannot save.");
      return;
    }
    // Disable save button and show saving indicator
    saveFileBtn.disabled = true;
    const originalText = saveFileBtn.textContent;
    saveFileBtn.textContent = 'Saving...';

    // Parse current editor content to xmlDoc before saving, but do NOT call updateEditor to avoid clearing editor
    let parser = new DOMParser();
    let parsedDoc = parser.parseFromString(editor.textContent, "application/xml");
    if (parsedDoc.getElementsByTagName('parsererror').length) {
      alert('Error parsing XML before saving');
      saveFileBtn.disabled = false;
      saveFileBtn.textContent = originalText;
      return;
    }
    xmlDoc = parsedDoc;
    try {
      const writable = await fileHandle.createWritable();
      await writable.write(editor.textContent);
      await writable.close();
      // Change save button color to green when pressed
      saveFileBtn.style.borderColor = 'green';
      saveFileBtn.style.backgroundColor = '#e6ffe6'; // light green background
    } catch (err) {
      alert("Error saving file: " + err.message);
    } finally {
      // Re-enable save button and restore text
      saveFileBtn.disabled = false;
      saveFileBtn.textContent = originalText;
    }
  });

  // Reset save button color to default when any input changes
  campaignIdInput.addEventListener('input', () => {
    saveFileBtn.style.borderColor = '';
    saveFileBtn.style.backgroundColor = '';
  });

  subjectInput.addEventListener('input', () => {
    saveFileBtn.style.borderColor = '';
    saveFileBtn.style.backgroundColor = '';
  });

  linkInput.addEventListener('input', () => {
    saveFileBtn.style.borderColor = '';
    saveFileBtn.style.backgroundColor = '';

    // Check mismatch warning when link input changes
    const campaignId = campaignIdInput.value.trim();
    const linkValue = linkInput.value.trim();
    const mismatchWarning = document.getElementById('mismatchWarning');
    const saveBtn = saveFileBtn;

    // Extract digits after underscore in campaign ID for matching
    let matchDigits = '';
    const underscoreIndex = campaignId.lastIndexOf('_');
    if (underscoreIndex !== -1) {
      const digitsPart = campaignId.substring(underscoreIndex + 1);
      if (digitsPart.length === 4) {
        matchDigits = digitsPart;
        matchDigitsLength = 4;
      } else if (digitsPart.length === 3) {
        matchDigits = digitsPart;
        matchDigitsLength = 3;
      }
    } else {
      // fallback to last 4 digits if no underscore found
      matchDigits = campaignId.slice(-4);
      matchDigitsLength = 4;
    }

    let mismatch = false;
    if (campaignId && linkValue) {
      // Extract last part of URL path for matching
      const urlParts = linkValue.split('/');
      const lastPart = urlParts[urlParts.length - 1] || '';
      // Match digits only at the start of lastPart before dash or other separator, exact match
      let regex;
      if (matchDigitsLength === 4) {
        regex = new RegExp('^' + matchDigits + '(-|\\.|_|$)');
      } else if (matchDigitsLength === 3) {
        regex = new RegExp('^' + matchDigits + '(-|\\.|_|$)');
      } else {
        regex = new RegExp('^' + matchDigits + '(-|\\.|_|$)');
      }
      console.log('Campaign ID:', campaignId);
      console.log('Match Digits:', matchDigits);
      console.log('Last URL Part:', lastPart);
      console.log('Regex:', regex);
      console.log('Regex test result:', regex.test(lastPart));
      if (!regex.test(lastPart)) {
        mismatch = true;
      }
    }

    if (mismatch) {
      campaignIdInput.style.borderColor = 'red';
      linkInput.style.borderColor = 'red';
      mismatchWarning.style.display = 'inline';
      saveBtn.disabled = true;
    } else {
      campaignIdInput.style.borderColor = '';
      linkInput.style.borderColor = '';
      mismatchWarning.style.display = 'none';
      saveBtn.disabled = false;
    }
  });

  function loadXmlFromText(xmlText) {
    let parser = new DOMParser();
    xmlDoc = parser.parseFromString(xmlText, "application/xml");
    if (xmlDoc.getElementsByTagName('parsererror').length) {
      alert('Error parsing XML');
      xmlDoc = null;
      return;
    }
    initializeFields();
    updateEditor();
  }

  function updateCampaignCountIndicator(campaignId) {
    if (!xmlDoc || !campaignId || campaignId.trim() === '') {
      campaignCountIndicator.textContent = "0/7";
      campaignCountIndicator.style.color = "red";
      return;
    }
    campaignId = campaignId.trim();
    let count = 0;
    xmlDoc.querySelectorAll('AudienceModel').forEach(el => {
      if (el.getAttribute('name') === campaignId) count++;
    });
    xmlDoc.querySelectorAll('Campaign').forEach(el => {
      if (el.getAttribute('name') === campaignId) count++;
      if (el.getAttribute('audience') === campaignId) count++;
    });
    xmlDoc.querySelectorAll('Interaction').forEach(el => {
      if (el.getAttribute('name') === campaignId) count++;
      if (el.getAttribute('message') === campaignId) count++;
    });
    xmlDoc.querySelectorAll('MessageContent').forEach(el => {
      if (el.getAttribute('name') === campaignId) count++;
    });
    xmlDoc.querySelectorAll('FilterValue').forEach(el => {
      if (el.getAttribute('value') === campaignId) count++;
    });

    campaignCountIndicator.textContent = count + "/7";
    campaignCountIndicator.style.color = (count === 7) ? "green" : "red";
  }

  function initializeFields() {
    // Get current campaign ID from xmlDoc (first AudienceModel or Campaign name attribute)
    let currentCampaignId = '';
    let audienceModel = xmlDoc.querySelector('AudienceModel');
    if (audienceModel) {
      currentCampaignId = audienceModel.getAttribute('name') || '';
    }
    if (!currentCampaignId) {
      let campaign = xmlDoc.querySelector('Campaign');
      if (campaign) {
        currentCampaignId = campaign.getAttribute('name') || '';
      }
    }
    campaignIdInput.value = currentCampaignId;

    updateCampaignCountIndicator(currentCampaignId);

    let messageContent = xmlDoc.querySelector('MessageContent');
    let subject = messageContent ? messageContent.getAttribute('subject') : '';
    subjectInput.value = subject;

    let messageBody = xmlDoc.querySelector('MessageBody');
    let link = messageBody ? messageBody.getAttribute('content') : '';
    linkInput.value = link;
  }

  campaignIdInput.addEventListener('input', () => {
    updateCampaignCountIndicator(campaignIdInput.value);

    // Validate no spaces in campaign ID input on input event
    if (/\s/.test(campaignIdInput.value)) {
      campaignIdInput.style.borderColor = 'red';
    } else {
      campaignIdInput.style.borderColor = '';
    }

    // Check mismatch warning when campaign ID input changes
    const campaignId = campaignIdInput.value.trim();
    const linkValue = linkInput.value.trim();
    const mismatchWarning = document.getElementById('mismatchWarning');
    const saveBtn = saveFileBtn;
    const linkBox = linkInput;

    // Extract last 4 or 3 digits from campaign ID for matching
    let last4Digits = campaignId.slice(-4);
    let last3Digits = campaignId.slice(-3);

    let mismatch = false;
    if (campaignId && linkValue) {
      if (!(linkValue.includes(last4Digits) || linkValue.includes(last3Digits))) {
        mismatch = true;
      }
    }

    if (mismatch) {
      campaignIdInput.style.borderColor = 'red';
      linkInput.style.borderColor = 'red';
      mismatchWarning.style.display = 'inline';
      saveBtn.disabled = true;
    } else {
      mismatchWarning.style.display = 'none';
      saveBtn.disabled = false;
      campaignIdInput.style.borderColor = '';
      linkBox.style.borderColor = '';
    }
  });

  updateCampaignIdBtn.addEventListener('click', () => {
    if (!xmlDoc) return alert("No XML loaded.");

    // Validate no spaces in campaign ID before updating
    if (/\s/.test(campaignIdInput.value)) {
      campaignIdInput.style.borderColor = 'red';
      alert('Campaign ID must not contain spaces.');
      return;
    }

    // Enable save button by default
    saveFileBtn.disabled = false;

    let audienceModel = xmlDoc.querySelector('AudienceModel');
    if (audienceModel) {
      audienceModel.setAttribute('name', campaignIdInput.value);
    }
    let filterValue = xmlDoc.querySelector('AudienceModel > Filter > FilterValue');
    if (filterValue) {
      filterValue.setAttribute('value', campaignIdInput.value);
    }
    let campaign = xmlDoc.querySelector('Campaign');
    if (campaign) {
      campaign.setAttribute('name', campaignIdInput.value);
      campaign.setAttribute('audience', campaignIdInput.value);
    }
    let interaction = xmlDoc.querySelector('Interaction');
    if (interaction) {
      interaction.setAttribute('name', campaignIdInput.value);
      interaction.setAttribute('message', campaignIdInput.value);
    }
    let messageContent = xmlDoc.querySelector('MessageContent');
    if (messageContent) {
      messageContent.setAttribute('name', campaignIdInput.value);
    }
    updateEditor();
    originalXmlContent = editor.value;

    // Update campaign ID character count display
    const campaignIdCharCountSpan = document.getElementById('campaignIdCharCount');
    if (campaignIdCharCountSpan) {
      campaignIdCharCountSpan.textContent = `(${campaignIdInput.value.length})`;
    }

    // Show checkmark icon next to campaignId input
    const checkmark = document.getElementById('campaignIdCheckmark');
    if (checkmark) {
      checkmark.style.display = 'inline';
    }

    // Remove mismatch warning and reset styles when campaign ID is updated
    const mismatchWarning = document.getElementById('mismatchWarning');
    const linkBox = linkInput;
    mismatchWarning.style.display = 'none';
    campaignIdInput.style.borderColor = '';
    linkBox.style.borderColor = '';
  });


  // Reset checkmark icon when campaign ID input changes
  campaignIdInput.addEventListener('input', () => {
    // updateCampaignIdBtn.style.backgroundColor = '';
    const checkmark = document.getElementById('campaignIdCheckmark');
    if (checkmark) {
      checkmark.style.display = 'none';
    }
  });

  subjectInput.addEventListener('input', () => {
    const checkmark = document.getElementById('subjectCheckmark');
    if (checkmark) {
      checkmark.style.display = 'none';
    }
  });

  linkInput.addEventListener('input', () => {
    const checkmark = document.getElementById('linkCheckmark');
    if (checkmark) {
      checkmark.style.display = 'none';
    }
  });

updateSubjectBtn.addEventListener('click', () => {
  if (!xmlDoc) return alert("No XML loaded.");
  let messageContent = xmlDoc.querySelector('MessageContent');
  if (messageContent) {
    // Replace multiple spaces with a single space before setting attribute
    let trimmedSubject = subjectInput.value.replace(/\s{2,}/g, ' ');

    // Replace inner KRHRED_xx inside <%[ ... ]|%> with KRHRED_Unit_xx to avoid double nesting
    trimmedSubject = trimmedSubject.replace(/<%\[KRHRED_([0-9]{1,2})\]\|%>/gi, (match, p1) => {
      const unitNumber = p1.padStart(2, '0');
      if (match.includes(`KRHRED_Unit_${unitNumber}`)) {
        return match;
      }
      return `<%[KRHRED_Unit_${unitNumber}]|%>`;
    });

    // Replace <krhred_xx> with <%[KRHRED_Unit_xx]|%>
    trimmedSubject = trimmedSubject.replace(/<krhred_([0-9]{1,2})>/gi, (match, p1) => {
      const unitNumber = p1.padStart(2, '0');
      return `<%[KRHRED_Unit_${unitNumber}]|%>`;
    });

    // Replace krhred_xx outside of <%[ ... ]|%> with <%[KRHRED_Unit_xx]|%>
    trimmedSubject = trimmedSubject.replace(/krhred_([0-9]{1,2})/gi, (match, p1) => {
      const unitNumber = p1.padStart(2, '0');
      return `<%[KRHRED_Unit_${unitNumber}]|%>`;
    });

    subjectInput.value = trimmedSubject;

    messageContent.setAttribute('subject', trimmedSubject);

    // Update character count display
    const charCountSpan = document.getElementById('subjectCharCount');
    charCountSpan.textContent = `(${trimmedSubject.length})`;

    // Reset subject input box style and enable save button
    subjectInput.style.borderColor = '';
    saveFileBtn.disabled = false;

    updateEditor();
    originalXmlContent = editor.value;

    // Show checkmark icon next to subject input
    const checkmark = document.getElementById('subjectCheckmark');
    if (checkmark) {
      checkmark.style.display = 'inline';
    }
  }
});



  updateLinkBtn.addEventListener('click', () => {
    if (!xmlDoc) return alert("No XML loaded.");
    let messageBody = xmlDoc.querySelector('MessageBody');
    if (messageBody) {
      // Validate link input to be a valid URL starting with http:// or https://
      let linkValue = linkInput.value.trim();
      const urlPattern = /^(http:\/\/|https:\/\/).+/i;
      if (!urlPattern.test(linkValue)) {
        alert('Please enter a valid link starting with http:// or https://');
        linkInput.style.borderColor = 'red';
        return;
      }
      // Convert https:// to http:// as requested
      if (linkValue.startsWith('https://')) {
        linkValue = 'http://' + linkValue.substring(8);
      }
      messageBody.setAttribute('content', linkValue);
      linkInput.style.borderColor = '';
    }
    updateEditor();
    originalXmlContent = editor.value;
    saveFileBtn.disabled = false;

    // Show checkmark icon next to link input
    const checkmark = document.getElementById('linkCheckmark');
    if (checkmark) {
      checkmark.style.display = 'inline';
    }
  });

  function updateEditor() {
    if (!xmlDoc) return;
    let serializer = new XMLSerializer();
    let updatedXmlStr = serializer.serializeToString(xmlDoc);
    updatedXmlStr = formatXml(updatedXmlStr);
    editor.textContent = updatedXmlStr;
  }

  folderOpenBtn.addEventListener('click', async () => {
    try {
      const dirHandle = await window.showDirectoryPicker();
      currentDirHandle = dirHandle; // Store the directory handle
      fileList.innerHTML = '';

      async function buildTree(dirHandle, parentUl) {
        const entries = [];
        for await (const entry of dirHandle.values()) {
          entries.push(entry);
        }
        // Separate directories and files
        const directories = entries.filter(e => e.kind === 'directory').sort((a, b) => a.name.localeCompare(b.name));
        const files = entries.filter(e => e.kind === 'file').sort((a, b) => a.name.localeCompare(b.name));
        // Append directories first
      for (const entry of directories) {
        const li = document.createElement('li');
        li.classList.add('folder');
        li.style.fontWeight = 'normal';

        // Create arrow span
        const arrowSpan = document.createElement('span');
        arrowSpan.classList.add('arrow');
        li.appendChild(arrowSpan);

        // Create folder icon span
        const folderIconSpan = document.createElement('span');
        folderIconSpan.classList.add('folder-icon');
        li.appendChild(folderIconSpan);

        // Create folder name span
        const folderNameSpan = document.createElement('span');
        folderNameSpan.classList.add('folder-name');
        folderNameSpan.textContent = entry.name;
        folderNameSpan.title = entry.name;
        li.appendChild(folderNameSpan);

        const subUl = document.createElement('ul');
        subUl.style.display = 'none';
        li.appendChild(subUl);

        arrowSpan.addEventListener('click', (e) => {
          e.stopPropagation();
          if (subUl.style.display === 'none') {
            subUl.style.display = 'block';
            li.classList.add('open');
          } else {
            subUl.style.display = 'none';
            li.classList.remove('open');
          }
        });

        folderNameSpan.addEventListener('click', (e) => {
          e.stopPropagation();
          if (subUl.style.display === 'none') {
            subUl.style.display = 'block';
            li.classList.add('open');
          } else {
            subUl.style.display = 'none';
            li.classList.remove('open');
          }
        });

        await buildTree(entry, subUl);
        parentUl.appendChild(li);
      }
        // Append files next
      for (const entry of files) {
        const li = document.createElement('li');
        li.classList.add('file');
        li.title = entry.name;
        // Create file icon span
        const fileIconSpan = document.createElement('span');
        fileIconSpan.classList.add('file-icon');
        fileIconSpan.textContent = "📄";
        li.appendChild(fileIconSpan);
        // Create file name span
        const fileNameSpan = document.createElement('span');
        fileNameSpan.classList.add('file-name');
        fileNameSpan.textContent = entry.name;
        li.appendChild(fileNameSpan);
        li.addEventListener('click', async (e) => {
          e.stopPropagation();
          fileHandle = entry; // Update fileHandle to enable saving changes
          const file = await entry.getFile();
          const text = await file.text();
          editor.value = text;
          loadXmlFromText(text);
          // Reset campaignIdCheckmark, subjectCheckmark, and linkCheckmark when switching files
          const campaignIdCheckmark = document.getElementById('campaignIdCheckmark');
          if (campaignIdCheckmark) {
            campaignIdCheckmark.style.display = 'none';
          }
          const subjectCheckmark = document.getElementById('subjectCheckmark');
          if (subjectCheckmark) {
            subjectCheckmark.style.display = 'none';
          }
          const linkCheckmark = document.getElementById('linkCheckmark');
          if (linkCheckmark) {
            linkCheckmark.style.display = 'none';
          }
          // Reset mismatch warning and input border colors when switching files
          const mismatchWarning = document.getElementById('mismatchWarning');
          if (mismatchWarning) {
            mismatchWarning.style.display = 'none';
          }
          campaignIdInput.style.borderColor = '';
          linkInput.style.borderColor = '';
          // Reset save button style when switching files
          saveFileBtn.style.borderColor = '';
          saveFileBtn.style.backgroundColor = '';
          // Highlight selected file
          const siblings = fileList.querySelectorAll('li');
          siblings.forEach(sib => sib.classList.remove('selected'));
          li.classList.add('selected');
        });
        parentUl.appendChild(li);
      }
      }

      await buildTree(dirHandle, fileList);
      saveState(); // Save state after opening folder
    } catch (err) {
      alert('Error opening folder: ' + err.message);
    }
  });

  function formatXml(xml) {
    let formatted = '';
    let reg = /(>)(<)(\/*)/g;
    xml = xml.replace(reg, '$1\r\n$2$3');
    let pad = 0;
    xml.split('\r\n').forEach((node) => {
      let indent = 0;
      if (node.match(/.+<\/\w[^>]*>$/)) {
        indent = 0;
      } else if (node.match(/^<\/\w/)) {
        if (pad !== 0) {
          pad -= 1;
        }
      } else if (node.match(/^<\w[^>]*[^\/]>.*$/)) {
        indent = 1;
      } else {
        indent = 0;
      }

      let padding = '';
      for (let i = 0; i < pad; i++) {i
        padding += '  ';
      }

      formatted += padding + node + '\r\n';
      pad += indent;
    });
    return formatted.trim();
  }
  // State persistence - simple approach
  let currentDirHandle = null;

  function saveState() {
    const state = {
      campaignId: campaignIdInput.value,
      subject: subjectInput.value,
      link: linkInput.value,
      xmlContent: editor.textContent,
      folderOpened: currentDirHandle !== null,
      fileListHTML: document.getElementById('fileList').innerHTML
    };
    localStorage.setItem('config_state', JSON.stringify(state));
  }

  function loadState() {
    const saved = localStorage.getItem('config_state');
    if (saved) {
      try {
        const state = JSON.parse(saved);
        campaignIdInput.value = state.campaignId || '';
        subjectInput.value = state.subject || '';
        linkInput.value = state.link || '';
        if (state.xmlContent) {
          editor.textContent = state.xmlContent;
          loadXmlFromText(state.xmlContent);
        }
        // Restore file list if it was opened before
        if (state.folderOpened && state.fileListHTML) {
          document.getElementById('fileList').innerHTML = state.fileListHTML;
          // Show message that folder needs to be reopened
          const folderBtn = document.getElementById('folderOpenBtn');
          folderBtn.textContent = 'Reopen Folder';
          folderBtn.style.backgroundColor = '#ff6b6b';
        }
      } catch (e) {
        console.error('Error loading state:', e);
      }
    }
  }

  // Auto-save on input changes
  campaignIdInput.addEventListener('input', saveState);
  subjectInput.addEventListener('input', saveState);
  linkInput.addEventListener('input', saveState);

  // Load state when page loads
  window.addEventListener('load', loadState);

  // Save state before leaving page
  window.addEventListener('beforeunload', saveState);

  // Add back button
  const backBtn = document.createElement('button');
  backBtn.innerHTML = '← Index';
  backBtn.style.cssText = 'position:fixed;top:10px;right:10px;z-index:999;background:#667eea;color:white;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;';
  backBtn.onclick = () => { saveState(); window.location.href = 'index.html'; };
  document.body.appendChild(backBtn);

</script>
</body>
</html>
