<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Campaign File Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <main class="max-w-5xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">Campaign File Generator</h1>
      <p class="text-slate-400 mt-1">Masukkan <span class="font-mono">Campaign ID</span> (wajib diawali <strong>YYYYMMDD</strong>, sisanya bebas) & banyak email → generate 4 file .txt: <span class="font-mono">CustMast</span>, <span class="font-mono">CustPref</span>, <span class="font-mono">CustSubs</span>, <span class="font-mono">CustAttr</span>.</p>
    </header>

    <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
      <div class="md:col-span-2">
        <label class="text-sm text-slate-300">Campaign ID</label>
        <input id="campaignId" class="mt-1 w-full rounded-2xl bg-slate-900 border border-slate-700 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono" placeholder="YYYYMMDD_nama_bebas" spellcheck="false" />
      </div>
      <div class="md:col-span-1">
        <label class="text-sm text-slate-300">Emails</label>
        <textarea id="emails" class="mt-1 w-full rounded-2xl bg-slate-900 border border-slate-700 px-4 py-3 h-32 resize-y focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono" placeholder="satu email per baris&#10;contoh1@mail.com&#10;contoh2@mail.com" spellcheck="false"></textarea>
        <div class="text-xs mt-1 text-slate-400 flex items-center gap-2">
          <span id="countInfo">Total: 0</span>
          <span id="invalidInfo" class="hidden text-rose-400"></span>
        </div>
      </div>
    </section>

    <div class="flex flex-wrap gap-3 mb-6">
      <button id="btnDownload" class="px-4 py-2 rounded-2xl shadow bg-indigo-600 hover:bg-indigo-500 disabled:opacity-40" disabled>Download 4 file</button>
      <button id="btnSave" class="px-4 py-2 rounded-2xl shadow bg-emerald-600 hover:bg-emerald-500 disabled:opacity-40" disabled>Save to folder</button>
    </div>

    <p id="error" class="text-amber-300 text-sm mb-4 hidden"></p>

    <section id="previews" class="grid grid-cols-1 md:grid-cols-2 gap-4"></section>

    <footer class="mt-6 text-xs text-slate-400">
      <p>Catatan: "Save to folder" memakai File System Access API (tersedia di Chrome/Edge desktop). Jika tidak didukung, gunakan tombol <em>Download 4 file</em>.</p>
    </footer>
  </main>

  <script>
    const $ = (sel) => document.querySelector(sel);

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const campaignRegex = /^\d{8}.*$/; // Wajib diawali 8 digit angka (YYYYMMDD)

    const campaignIdEl = $('#campaignId');
    const emailsEl = $('#emails');
    const btnDownload = $('#btnDownload');
    const btnSave = $('#btnSave');
    const errorEl = $('#error');
    const previewsEl = $('#previews');
    const countInfo = $('#countInfo');
    const invalidInfo = $('#invalidInfo');

    function parseEmails(text) {
      const raw = text.split(/[\n,\s]+/).map(s => s.trim()).filter(Boolean);
      const seen = new Set();
      const list = [];
      for (const e of raw) { if (!seen.has(e)) { seen.add(e); list.push(e); } }
      return list;
    }

    function recordId(campaignId, i) {
      return `${campaignId}-${String(i + 1).padStart(6, '0')}`;
    }

    function rowCustMast(id, email) {
      const emptyCount = 17;
      const empties = Array(emptyCount).fill('').join('|');
      return `${id}|${email}|${empties}|\n`;
    }
    function rowCustPref(id, email, campaignId) {
      return `${id}|${email}|CMPG_ID|${campaignId}|\n`;
    }
    function rowCustSubs(id, email) {
      return `${id}|${email}|IMO Marketing|Y|\n`;
    }
    function rowCustAttr(id, email, campaignId) {
      return `${id}|${email}|CMPG_ID|${campaignId}|\n`;
    }

    function buildAllFiles(campaignId, emails) {
      let mast = '', pref = '', subs = '', attr = '';
      emails.forEach((email, i) => {
        const id = recordId(campaignId, i);
        mast += rowCustMast(id, email);
        pref += rowCustPref(id, email, campaignId);
        subs += rowCustSubs(id, email);
        attr += rowCustAttr(id, email, campaignId);
      });
      return {
        [`${campaignId}-CustMast.txt`]: mast,
        [`${campaignId}-CustPref.txt`]: pref,
        [`${campaignId}-CustSubs.txt`]: subs,
        [`${campaignId}-CustAttr.txt`]: attr,
      };
    }

    function downloadText(filename, content) {
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    async function saveAllToFolder(files) {
      errorEl.classList.add('hidden');
      try {
        if (!('showDirectoryPicker' in window)) throw new Error("Browser Anda tidak mendukung 'Save to folder'. Coba Chrome/Edge desktop.");
        const dirHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
        for (const [name, content] of Object.entries(files)) {
          const fileHandle = await dirHandle.getFileHandle(name, { create: true });
          const writable = await fileHandle.createWritable();
          await writable.write(content); await writable.close();
        }
      } catch (e) {
        if (e && e.name === 'AbortError') return;
        errorEl.textContent = e?.message || 'Gagal menyimpan ke folder.';
        errorEl.classList.remove('hidden');
      }
    }

    function updateUI() {
      const campaignId = campaignIdEl.value.trim();
      const emails = parseEmails(emailsEl.value);
      const invalid = emails.filter(e => !emailRegex.test(e));

      countInfo.textContent = `Total: ${emails.length}`;
      if (invalid.length) {
        invalidInfo.textContent = `Invalid: ${invalid.slice(0,3).join(', ')}${invalid.length>3?', …':''}`;
        invalidInfo.classList.remove('hidden');
      } else {
        invalidInfo.classList.add('hidden');
      }

      const ok = campaignRegex.test(campaignId) && emails.length > 0 && invalid.length === 0;
      btnDownload.disabled = !ok; btnSave.disabled = !ok;

      previewsEl.innerHTML = '';
      if (!ok) return;
      const show = Math.min(emails.length, 5);
      const ids = Array.from({length: show}, (_, i) => recordId(campaignId, i));
      const sample = emails.slice(0, show);
      const previews = {
        [`${campaignId}-CustMast.txt`]: sample.map((e,i)=>rowCustMast(ids[i], e)).join('') + (emails.length>show?'…\n':''),
        [`${campaignId}-CustPref.txt`]: sample.map((e,i)=>rowCustPref(ids[i], e, campaignId)).join('') + (emails.length>show?'…\n':''),
        [`${campaignId}-CustSubs.txt`]: sample.map((e,i)=>rowCustSubs(ids[i], e)).join('') + (emails.length>show?'…\n':''),
        [`${campaignId}-CustAttr.txt`]: sample.map((e,i)=>rowCustAttr(ids[i], e, campaignId)).join('') + (emails.length>show?'…\n':''),
      };
      for (const [name, content] of Object.entries(previews)) {
        const card = document.createElement('div');
        card.className = 'bg-slate-900 rounded-2xl shadow p-4';
        card.innerHTML = `<div class="flex items-center justify-between"><h3 class="font-medium text-slate-200 truncate pr-2">${name}</h3><span class="text-[10px] px-2 py-1 rounded-full bg-slate-800 border border-slate-700">preview</span></div><pre class="mt-3 text-sm overflow-auto max-h-40 whitespace-pre-wrap leading-relaxed font-mono text-slate-300"></pre>`;
        card.querySelector('pre').textContent = content;
        previewsEl.appendChild(card);
      }
    }

    campaignIdEl.addEventListener('input', updateUI);
    emailsEl.addEventListener('input', updateUI);

    btnDownload.addEventListener('click', () => {
      const files = buildAllFiles(campaignIdEl.value.trim(), parseEmails(emailsEl.value));
      Object.entries(files).forEach(([name, content]) => downloadText(name, content));
    });

    btnSave.addEventListener('click', async () => {
      const files = buildAllFiles(campaignIdEl.value.trim(), parseEmails(emailsEl.value));
      await saveAllToFolder(files);
    });

    updateUI();
  </script>
</body>
</html>
